name: CI/CD Pipeline for PetClinic

on:
  push:
    branches: 
      - main
      - develop
      - 'feature/*'
  pull_request:
    branches: 
      - main
      - develop

env:
  AWS_ACCOUNT_ID: "865258959313"  # æ›¿æ¢ä¸ºä½ çš„ AWS è´¦å·
  AWS_DEFAULT_REGION: "ap-east-1"
  JAVA_VERSION: "17"

jobs:
  # Job 1: ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  code-quality:
    name: ðŸ” Code Quality & Tests
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check-deploy.outputs.should-deploy }}
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ðŸ§ª Run Tests
        run: |
          ./mvnw clean test -B

      - name: ðŸ“Š Generate Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: ðŸ“‹ Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false

      - name: ðŸŽ¯ Check if Should Deploy
        id: check-deploy
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Main branch - will deploy"
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Feature branch - skipping deployment"
          fi

  # Job 2: æž„å»ºå’ŒæŽ¨é€ Docker é•œåƒ
  build-and-push:
    name: ðŸ³ Build & Push Docker Image
    needs: code-quality
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ steps.build.outputs.image-uri }}
      image-tag: ${{ steps.build.outputs.image-tag }}
    
    steps:
      - name: ðŸ—ï¸ Build Docker Image
        id: build
        uses: https://github.com/wujunlin555/workflows/blob/main/.github/workflows/java-ecr-workflow.yml@main
        with:
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
          aws-account-id: ${{ env.AWS_ACCOUNT_ID }}
          java-version: ${{ env.JAVA_VERSION }}
          enable-tests: false  # å·²åœ¨ä¸Šä¸€ä¸ª job ä¸­æµ‹è¯•è¿‡
          platforms: "linux/amd64"
        secrets:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # Job 3: éƒ¨ç½²é€šçŸ¥
  notify:
    name: ðŸ“¬ Build Complete
    needs: [code-quality, build-and-push]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Build Summary
        run: |
          echo "## ðŸ—ï¸ PetClinic Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.code-quality.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-and-push.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build-and-push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build-and-push.outputs.image-uri }}" != "" ]]; then
            echo "**ðŸ³ Docker Image:** \`${{ needs.build-and-push.outputs.image-uri }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "docker run -p 8080:8080 ${{ needs.build-and-push.outputs.image-uri }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
